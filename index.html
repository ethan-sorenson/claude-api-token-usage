<!DOCTYPE html>
<html lang="en">
<!--
    SETUP INSTRUCTIONS:
    This demo requires running from a local web server due to CORS restrictions.
    
    Option 1 - Python (easiest):
    1. Open terminal in the folder containing this file
    2. Run: python -m http.server 8000
    3. Open browser to: http://localhost:8000/claude-api-demo.html
    
    Option 2 - Node.js:
    1. Install: npm install -g http-server
    2. Run: http-server -p 8000
    3. Open browser to: http://localhost:8000/claude-api-demo.html
    
    Option 3 - VS Code:
    1. Install "Live Server" extension
    2. Right-click this file and select "Open with Live Server"
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eOne - Claude API Demo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #F4F4F4;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: #FFFFFF;
            color: #000000;
            padding: 30px;
            border-bottom: 3px solid #3533FF;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 20px;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .metric-card {
            background: #FFFFFF;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #E2E2E4;
        }

        .metric-label {
            font-size: 12px;
            color: #929395;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #3533FF;
        }

        .context-bar {
            width: 100%;
            height: 30px;
            background: #E2E2E4;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 15px;
            position: relative;
        }

        .context-fill {
            height: 100%;
            background: linear-gradient(90deg, #6AFF96 0%, #FFEB55 70%, #FF5A26 90%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: #000000;
            font-size: 12px;
            font-weight: bold;
        }

        .config-section {
            padding: 25px 30px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .config-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .config-group {
            flex: 1;
            min-width: 250px;
        }

        .config-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 5px;
        }

        .config-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
        }

        .config-group input:focus {
            outline: none;
            border-color: #3533FF;
            box-shadow: 0 0 0 3px rgba(53, 51, 255, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            font-weight: 600;
            color: #475569;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3533FF;
            color: white;
        }

        .btn-primary:hover {
            background: #2826CC;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-connected {
            background: #d1fae5;
            color: #065f46;
        }

        .status-disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            height: 600px;
        }

        .chat-area {
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e2e8f0;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8fafc;
        }

        .message {
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-user {
            display: flex;
            justify-content: flex-end;
        }

        .message-assistant {
            display: flex;
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 15px;
            border-radius: 12px;
            position: relative;
        }

        .message-user .message-content {
            background: #3533FF;
            color: white;
        }

        .message-assistant .message-content {
            background: white;
            border: 1px solid #e2e8f0;
            color: #1e293b;
        }

        .token-badge {
            display: inline-block;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            margin-top: 5px;
            font-weight: 600;
        }

        .message-user .token-badge {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .message-assistant .token-badge {
            background: #B0F2FF;
            color: #3533FF;
        }

        .tool-usage {
            margin-top: 10px;
            padding: 10px;
            background: #FFEB55;
            border-radius: 6px;
            border-left: 3px solid #FF5A26;
        }

        .tool-usage-header {
            font-weight: 600;
            font-size: 12px;
            color: #000000;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tool-detail {
            font-size: 11px;
            color: #313131;
            margin: 3px 0;
            font-family: 'Courier New', monospace;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
        }

        .input-group textarea:focus {
            outline: none;
            border-color: #3533FF;
            box-shadow: 0 0 0 3px rgba(53, 51, 255, 0.1);
        }

        .sidebar {
            background: #f1f5f9;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h3 {
            font-size: 16px;
            color: #334155;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #cbd5e1;
        }

        .message-breakdown {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 13px;
            border: 1px solid #e2e8f0;
        }

        .breakdown-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 5px 0;
        }

        .breakdown-label {
            color: #64748b;
        }

        .breakdown-value {
            font-weight: 600;
            color: #334155;
        }

        .demo-scenarios {
            margin-top: 20px;
        }

        .scenario-btn {
            width: 100%;
            text-align: left;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scenario-btn:hover {
            background: #3533FF;
            color: white;
            border-color: #3533FF;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #E2E2E4;
            border-top-color: #3533FF;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 3px solid #ef4444;
            font-size: 13px;
        }

        .cost-estimate {
            font-size: 11px;
            color: #64748b;
            margin-top: 5px;
        }

        .mcp-config {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
        }

        .mcp-config.active {
            display: block;
        }

        .footer-branding {
            text-align: right;
            padding: 15px 30px;
            background: #FFFFFF;
            border-top: 1px solid #E2E2E4;
            color: #767676;
            font-size: 12px;
            font-weight: 400;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Claude API Token & Context Window Demo</h1>
            <div class="metrics">
                <div class="metric-card">
                    <div class="metric-label">Conversation Tokens</div>
                    <div class="metric-value" id="totalTokens">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Context Window</div>
                    <input type="number" id="contextWindow" value="200000" style="font-size: 20px; font-weight: bold; color: #3533FF; border: none; background: transparent; width: 100%; padding: 0;" onchange="updateContextWindow()" title="Adjust context window size (Sonnet 4: 200,000 | Opus 4: 200,000 | Haiku: 200,000)">
                </div>
                <div class="metric-card">
                    <div class="metric-label">Usage %</div>
                    <div class="metric-value" id="usagePercent">0%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Est. Cost</div>
                    <div class="metric-value" id="totalCost">$0.00</div>
                </div>
            </div>
            <div class="context-bar">
                <div class="context-fill" id="contextFill" style="width: 0%">
                    <span id="contextText"></span>
                </div>
            </div>
        </div>

        <div class="config-section">
            <div class="config-row">
                <div class="config-group">
                    <label for="apiKey">Anthropic API Key</label>
                    <input type="password" id="apiKey" placeholder="sk-ant-...">
                </div>
                <div class="config-group" style="flex: 0 0 auto; display: flex; align-items: flex-end; gap: 10px;">
                    <button class="btn btn-danger" onclick="resetConversation()">Reset Conversation</button>
                </div>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="enableMcp" onchange="toggleMcpConfig()">
                <label for="enableMcp">Enable Popdock MCP Server</label>
                <div id="mcpStatus" class="status-indicator status-disconnected">
                    <span>‚óè</span> Disconnected
                </div>
            </div>

            <div id="mcpConfig" class="mcp-config">
                <div class="config-row">
                    <div class="config-group">
                        <label for="mcpUrl">MCP Server URL</label>
                        <input type="text" id="mcpUrl" placeholder="https://mcp-eqa.popdock.com/mcp/...">
                    </div>
                </div>
                <div class="config-row">
                    <div class="config-group">
                        <label for="mcpToken">Popdock Token</label>
                        <input type="password" id="mcpToken" placeholder="Your Popdock token">
                    </div>
                    <div class="config-group">
                        <label for="mcpName">Server Name</label>
                        <input type="text" id="mcpName" value="Popdock-CRM" placeholder="Popdock-CRM">
                    </div>
                </div>
                <button class="btn btn-success" onclick="testMcpConnection()">Test Connection</button>
            </div>
        </div>

        <div class="main-content">
            <div class="chat-area">
                <div class="messages" id="messages">
                    <div class="message message-assistant">
                        <div class="message-content">
                            <p>Welcome! I'm ready to demonstrate Claude API with token tracking and MCP integration.</p>
                            <p style="margin-top: 10px; font-size: 13px; opacity: 0.8;">Configure your API key above and start chatting to see real-time token usage and context window visualization.</p>
                        </div>
                    </div>
                </div>
                <div class="input-area">
                    <div id="errorContainer"></div>
                    <div class="input-group">
                        <textarea id="userInput" rows="3" placeholder="Type your message here..." onkeydown="handleKeyPress(event)"></textarea>
                        <button class="btn btn-primary" onclick="sendMessage()" style="align-self: flex-end;">
                            Send
                        </button>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <h3>üìä Token Breakdown</h3>
                <div id="breakdown"></div>

                <div class="demo-scenarios">
                    <h3>üí° Demo Scenarios</h3>
                    <button class="scenario-btn" onclick="runScenario('simple')">
                        Simple Question (Low tokens)
                    </button>
                    <button class="scenario-btn" onclick="runScenario('analysis')">
                        Data Analysis Request
                    </button>
                    <button class="scenario-btn" onclick="runScenario('mcp-invoices')">
                        MCP: Get Customer Invoices
                    </button>
                    <button class="scenario-btn" onclick="runScenario('mcp-opportunities')">
                        MCP: List Opportunities
                    </button>
                </div>

                <div style="margin-top: 20px; padding: 12px; background: white; border-radius: 6px; font-size: 12px; color: #64748b;">
                    <strong>Pricing (Sonnet 4):</strong><br>
                    Input: $3.00 / 1M tokens<br>
                    Output: $15.00 / 1M tokens
                </div>
            </div>
        </div>

        <div class="footer-branding">
            eOne Partner Report
        </div>
    </div>

    <script>
        // Global state
        let conversationHistory = [];
        let totalInputTokens = 0;
        let totalOutputTokens = 0;
        let CONTEXT_WINDOW = 200000;
        const INPUT_PRICE = 3.00 / 1000000; // per token
        const OUTPUT_PRICE = 15.00 / 1000000; // per token

        // Initialize
        loadFromSession();
        checkProtocol();

        function updateContextWindow() {
            const input = document.getElementById('contextWindow');
            const value = parseInt(input.value) || 200000;
            CONTEXT_WINDOW = value;
            updateMetrics();
            sessionStorage.setItem('contextWindow', value);
        }

        function checkProtocol() {
            if (window.location.protocol === 'file:') {
                showError('‚ö†Ô∏è WARNING: This page is opened as a local file. API calls will fail due to CORS. Please run a local web server: "python -m http.server 8000" then open http://localhost:8000/claude-api-demo.html', true);
            }
        }

        function saveToSession() {
            sessionStorage.setItem('apiKey', document.getElementById('apiKey').value);
            sessionStorage.setItem('mcpUrl', document.getElementById('mcpUrl').value);
            sessionStorage.setItem('mcpToken', document.getElementById('mcpToken').value);
            sessionStorage.setItem('mcpName', document.getElementById('mcpName').value);
        }

        function loadFromSession() {
            const apiKey = sessionStorage.getItem('apiKey');
            const mcpUrl = sessionStorage.getItem('mcpUrl');
            const mcpToken = sessionStorage.getItem('mcpToken');
            const mcpName = sessionStorage.getItem('mcpName');
            const contextWindow = sessionStorage.getItem('contextWindow');
            
            if (apiKey) document.getElementById('apiKey').value = apiKey;
            if (mcpUrl) document.getElementById('mcpUrl').value = mcpUrl;
            if (mcpToken) document.getElementById('mcpToken').value = mcpToken;
            if (mcpName) document.getElementById('mcpName').value = mcpName;
            if (contextWindow) {
                document.getElementById('contextWindow').value = contextWindow;
                CONTEXT_WINDOW = parseInt(contextWindow);
            }
        }

        function toggleMcpConfig() {
            const checkbox = document.getElementById('enableMcp');
            const config = document.getElementById('mcpConfig');
            
            if (checkbox.checked) {
                config.classList.add('active');
            } else {
                config.classList.remove('active');
                updateMcpStatus(false);
            }
        }

        function updateMcpStatus(connected) {
            const status = document.getElementById('mcpStatus');
            if (connected) {
                status.className = 'status-indicator status-connected';
                status.innerHTML = '<span>‚óè</span> Connected';
            } else {
                status.className = 'status-indicator status-disconnected';
                status.innerHTML = '<span>‚óè</span> Disconnected';
            }
        }

        function testMcpConnection() {
            const url = document.getElementById('mcpUrl').value;
            const token = document.getElementById('mcpToken').value;
            
            if (!url || !token) {
                showError('Please enter both MCP URL and token');
                return;
            }

            // For now, just update status - actual test would require MCP endpoint
            updateMcpStatus(true);
            showError('MCP configuration saved (connection test simulated)', false);
            saveToSession();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage(customMessage = null) {
            const apiKey = document.getElementById('apiKey').value;
            const userInput = document.getElementById('userInput');
            const message = customMessage || userInput.value.trim();

            if (!apiKey) {
                showError('Please enter your Anthropic API key');
                return;
            }

            if (!message) {
                showError('Please enter a message');
                return;
            }

            saveToSession();
            clearError();

            // Add user message to UI
            addMessageToUI('user', message);
            if (!customMessage) userInput.value = '';

            // Add to conversation history
            conversationHistory.push({
                role: 'user',
                content: message
            });

            // Prepare API request
            const requestBody = {
                model: 'claude-sonnet-4-20250514',
                max_tokens: 2000,
                messages: conversationHistory
            };

            // Add MCP server if enabled
            const mcpEnabled = document.getElementById('enableMcp').checked;
            if (mcpEnabled) {
                const mcpUrl = document.getElementById('mcpUrl').value;
                const mcpToken = document.getElementById('mcpToken').value;
                const mcpName = document.getElementById('mcpName').value;

                if (mcpUrl && mcpToken) {
                    requestBody.mcp_servers = [{
                        type: 'url',
                        url: `${mcpUrl}?token=${mcpToken}`,
                        name: mcpName || 'Popdock-CRM'
                    }];
                }
            }

            // Show loading
            const loadingId = addLoadingMessage();

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify(requestBody)
                });

                removeLoadingMessage(loadingId);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API request failed');
                }

                const data = await response.json();
                
                // Extract token usage
                const inputTokens = data.usage.input_tokens;
                const outputTokens = data.usage.output_tokens;

                // Update totals
                totalInputTokens += inputTokens;
                totalOutputTokens += outputTokens;
                updateMetrics();

                // Process response content
                let assistantMessage = '';
                let toolUsage = [];

                for (const block of data.content) {
                    if (block.type === 'text') {
                        assistantMessage += block.text;
                    } else if (block.type === 'mcp_tool_use') {
                        toolUsage.push({
                            type: 'tool_use',
                            name: block.name,
                            input: block.input
                        });
                    } else if (block.type === 'mcp_tool_result') {
                        toolUsage.push({
                            type: 'tool_result',
                            content: block.content
                        });
                    }
                }

                // Add assistant message to UI
                addMessageToUI('assistant', assistantMessage, outputTokens, toolUsage);

                // Add to conversation history
                conversationHistory.push({
                    role: 'assistant',
                    content: data.content
                });

                // Update breakdown
                addToBreakdown(conversationHistory.length, inputTokens, outputTokens);

            } catch (error) {
                removeLoadingMessage(loadingId);
                
                // Check if it's a CORS/network error
                if (error.message === 'Failed to fetch' || error.name === 'TypeError') {
                    showError(`Network Error: This demo must be run from a web server, not opened directly as a file. See instructions at the top of the HTML file. Quick fix: Run "python -m http.server 8000" in the file's directory, then open http://localhost:8000/claude-api-demo.html`);
                } else {
                    showError(`Error: ${error.message}`);
                }
                console.error('API Error:', error);
            }
        }

        function addMessageToUI(role, content, tokens = 0, toolUsage = []) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${role}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            const textP = document.createElement('p');
            textP.textContent = content || '(No text response)';
            textP.style.whiteSpace = 'pre-wrap';
            contentDiv.appendChild(textP);

            if (tokens > 0) {
                const badge = document.createElement('div');
                badge.className = 'token-badge';
                badge.textContent = `‚Üê ${tokens} tokens`;
                contentDiv.appendChild(badge);
            }

            // Add tool usage if present
            if (toolUsage.length > 0) {
                const toolDiv = document.createElement('div');
                toolDiv.className = 'tool-usage';
                
                const header = document.createElement('div');
                header.className = 'tool-usage-header';
                header.textContent = 'üîß Tools Used';
                toolDiv.appendChild(header);

                toolUsage.forEach(tool => {
                    if (tool.type === 'tool_use') {
                        const detail = document.createElement('div');
                        detail.className = 'tool-detail';
                        detail.textContent = `Called: ${tool.name}`;
                        toolDiv.appendChild(detail);

                        const params = document.createElement('div');
                        params.className = 'tool-detail';
                        params.textContent = `Params: ${JSON.stringify(tool.input).substring(0, 100)}...`;
                        toolDiv.appendChild(params);
                    }
                });

                contentDiv.appendChild(toolDiv);
            }

            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addLoadingMessage() {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            const id = 'loading-' + Date.now();
            messageDiv.id = id;
            messageDiv.className = 'message message-assistant';
            messageDiv.innerHTML = `
                <div class="message-content">
                    <span class="loading"></span> Thinking...
                </div>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return id;
        }

        function removeLoadingMessage(id) {
            const element = document.getElementById(id);
            if (element) element.remove();
        }

        function updateMetrics() {
            const total = totalInputTokens + totalOutputTokens;
            const percentage = ((total / CONTEXT_WINDOW) * 100).toFixed(2);
            const cost = (totalInputTokens * INPUT_PRICE + totalOutputTokens * OUTPUT_PRICE).toFixed(4);

            document.getElementById('totalTokens').textContent = total.toLocaleString();
            document.getElementById('usagePercent').textContent = percentage + '%';
            document.getElementById('totalCost').textContent = '$' + cost;

            const contextFill = document.getElementById('contextFill');
            contextFill.style.width = Math.min(percentage, 100) + '%';
            
            if (percentage > 0) {
                document.getElementById('contextText').textContent = `${percentage}%`;
            }
        }

        function addToBreakdown(messageNum, inputTokens, outputTokens) {
            const breakdownDiv = document.getElementById('breakdown');
            const card = document.createElement('div');
            card.className = 'message-breakdown';
            
            card.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px; color: #334155;">Message #${Math.ceil(messageNum / 2)}</div>
                <div class="breakdown-row">
                    <span class="breakdown-label">Input:</span>
                    <span class="breakdown-value">${inputTokens.toLocaleString()}</span>
                </div>
                <div class="breakdown-row">
                    <span class="breakdown-label">Output:</span>
                    <span class="breakdown-value">${outputTokens.toLocaleString()}</span>
                </div>
                <div class="breakdown-row" style="border-top: 1px solid #e2e8f0; padding-top: 5px;">
                    <span class="breakdown-label">Total:</span>
                    <span class="breakdown-value">${(inputTokens + outputTokens).toLocaleString()}</span>
                </div>
                <div class="cost-estimate">
                    Cost: $${(inputTokens * INPUT_PRICE + outputTokens * OUTPUT_PRICE).toFixed(4)}
                </div>
            `;
            
            breakdownDiv.appendChild(card);
            breakdownDiv.scrollTop = breakdownDiv.scrollHeight;
        }

        function resetConversation() {
            if (confirm('Reset conversation and clear all messages?')) {
                try {
                    conversationHistory = [];
                    totalInputTokens = 0;
                    totalOutputTokens = 0;
                    document.getElementById('messages').innerHTML = `
                        <div class="message message-assistant">
                            <div class="message-content">
                                <p>Welcome! I'm ready to demonstrate Claude API with token tracking and MCP integration.</p>
                                <p style="margin-top: 10px; font-size: 13px; opacity: 0.8;">Configure your API key above and start chatting to see real-time token usage and context window visualization.</p>
                            </div>
                        </div>
                    `;
                    document.getElementById('breakdown').innerHTML = '';
                    clearError();
                    updateMetrics();
                    console.log('Conversation reset successfully');
                } catch (error) {
                    console.error('Error resetting conversation:', error);
                    showError('Error resetting conversation: ' + error.message);
                }
            }
        }

        // Make function globally accessible
        window.resetConversation = resetConversation;

        function showError(message, isError = true) {
            const container = document.getElementById('errorContainer');
            const div = document.createElement('div');
            div.className = isError ? 'error-message' : 'error-message';
            div.style.background = isError ? '#fee2e2' : '#d1fae5';
            div.style.color = isError ? '#991b1b' : '#065f46';
            div.style.borderLeftColor = isError ? '#ef4444' : '#10b981';
            div.textContent = message;
            container.innerHTML = '';
            container.appendChild(div);
            
            // Don't auto-dismiss if it contains WARNING or server instructions
            if (!message.includes('WARNING') && !message.includes('python -m http.server')) {
                setTimeout(() => {
                    div.remove();
                }, 5000);
            }
        }

        function clearError() {
            document.getElementById('errorContainer').innerHTML = '';
        }

        function runScenario(scenario) {
            const scenarios = {
                'simple': 'Hi! What is 2 + 2?',
                'analysis': 'Can you explain how context windows work in AI models and why they matter?',
                'mcp-invoices': 'Show me recent customer invoices from Business Central',
                'mcp-opportunities': 'What open sales opportunities do we have?'
            };

            const message = scenarios[scenario];
            if (message) {
                document.getElementById('userInput').value = message;
                sendMessage(message);
            }
        }

        // Make all onclick functions globally accessible
        window.toggleMcpConfig = toggleMcpConfig;
        window.testMcpConnection = testMcpConnection;
        window.sendMessage = sendMessage;
        window.runScenario = runScenario;
        window.handleKeyPress = handleKeyPress;
        window.updateContextWindow = updateContextWindow;
    </script>
</body>
</html>